// エラーが閉じられた後、cmdウィンドウを探して操作

// 現在の画面状態をキャプチャ
SAVEIMG("C:\Users\user\claude-test-100-v0.2\auto-claude-start\current_clean_state.jpg", 0, , , , , , 80)

// ログファイル
fid = FOPEN("C:\Users\user\claude-test-100-v0.2\auto-claude-start\cmd_window_test_log.txt", F_WRITE)
FPUT(fid, "=== CMD Window Search ===")
FPUT(fid, "")

// 全ウィンドウを取得
count = GETALLWIN()
FPUT(fid, "Total windows: " + count)
FPUT(fid, "")

// cmdウィンドウを探す
cmd_windows = 0
my_window_id = 0

FOR i = 0 TO count - 1
    id = ALL_WIN_ID[i]
    IF id > 0 THEN
        title = STATUS(id, ST_TITLE)
        clsname = STATUS(id, ST_CLASS)
        pid = STATUS(id, ST_PROCESS)
        visible = STATUS(id, ST_VISIBLE)
        
        // cmdウィンドウっぽいものを探す
        IF (POS("cmd", title) > 0 OR POS("Command", title) > 0 OR clsname = "ConsoleWindowClass" OR clsname = "PseudoConsoleWindow") AND visible THEN
            cmd_windows = cmd_windows + 1
            
            FPUT(fid, "CMD Window #" + cmd_windows)
            FPUT(fid, "  ID: " + id)
            FPUT(fid, "  PID: " + pid)
            FPUT(fid, "  Title: " + title)
            FPUT(fid, "  Class: " + clsname)
            
            // 私のウィンドウかチェック
            IF POS("claude-test-100", title) > 0 THEN
                FPUT(fid, "  *** MY WINDOW - DO NOT CLOSE ***")
                my_window_id = id
            ELSE
                // 他のcmdウィンドウを発見
                FPUT(fid, "  >>> Other CMD window found!")
                
                // このウィンドウをアクティブにして確認
                CTRLWIN(id, ACTIVATE)
                SLEEP(1)
                SAVEIMG("C:\Users\user\claude-test-100-v0.2\auto-claude-start\other_cmd_" + id + ".jpg", 0, , , , , , 80)
                
                // 元に戻す
                CTRLWIN(my_window_id, ACTIVATE)
            ENDIF
            
            FPUT(fid, "")
        ENDIF
    ENDIF
NEXT

FPUT(fid, "Total CMD windows found: " + cmd_windows)
FCLOSE(fid)

// 最終状態をキャプチャ
SAVEIMG("C:\Users\user\claude-test-100-v0.2\auto-claude-start\final_state.jpg", 0, , , , , , 80)