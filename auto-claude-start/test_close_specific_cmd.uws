// 特定のcmdウィンドウを安全にテストする

// 現在の画面をキャプチャ
SAVEIMG("C:\Users\user\claude-test-100-v0.2\auto-claude-start\before_close_test.jpg", 0, , , , , , 80)

// プロセスベースで探す
// tasklist | findstr cmd.exe
EXEC("powershell.exe -Command \"Get-Process cmd | Select-Object Id, MainWindowTitle | Out-File -FilePath 'C:\Users\user\claude-test-100-v0.2\auto-claude-start\cmd_processes.txt'\"")
SLEEP(2)

// 画面に見えているcmdウィンドウの位置から推測
// 左側（私）、中央（閉じても良い？）、右側（閉じても良い？）

// 中央のcmdウィンドウを探してみる（タイトルが違うはず）
count = GETALLWIN()
target_found = FALSE

FOR i = 0 TO count - 1
    id = ALL_WIN_ID[i]
    IF id > 0 THEN
        title = STATUS(id, ST_TITLE)
        
        // 私以外のcmdを探す
        IF (POS("cmd.exe", title) > 0 OR POS("Command Prompt", title) > 0) AND POS("claude-test", title) = 0 THEN
            // ログに記録
            fid = FOPEN("C:\Users\user\claude-test-100-v0.2\auto-claude-start\found_other_cmd.txt", F_WRITE)
            FPUT(fid, "Found potential cmd to close:")
            FPUT(fid, "ID: " + id)
            FPUT(fid, "Title: " + title)
            FCLOSE(fid)
            
            target_found = TRUE
            
            // 念のため、このウィンドウを一時的にアクティブにして確認
            CTRLWIN(id, ACTIVATE)
            SLEEP(1)
            SAVEIMG("C:\Users\user\claude-test-100-v0.2\auto-claude-start\activated_cmd_" + id + ".jpg", 0, , , , , , 80)
            
            BREAK
        ENDIF
    ENDIF
NEXT

IF NOT target_found THEN
    fid = FOPEN("C:\Users\user\claude-test-100-v0.2\auto-claude-start\found_other_cmd.txt", F_WRITE)
    FPUT(fid, "No other cmd windows found")
    FCLOSE(fid)
ENDIF