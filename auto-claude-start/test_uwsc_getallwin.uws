// UWSCスクリプト - 正しい方法でウィンドウ一覧を取得

// ログファイルを開く
fid = FOPEN("C:\Users\user\claude-test-100-v0.2\auto-claude-start\uwsc_window_list.txt", F_WRITE)

// 起動前のウィンドウ一覧を取得
FPUT(fid, "=== 起動前のウィンドウ一覧 ===")
GETTIME()
FPUT(fid, "時刻: " + G_TIME_YY4 + "/" + G_TIME_MM2 + "/" + G_TIME_DD2 + " " + G_TIME_HH2 + ":" + G_TIME_NN2 + ":" + G_TIME_SS2)

// 全ウィンドウを取得
win_count = GETALLWIN()
FPUT(fid, "総ウィンドウ数: " + win_count)

// 可視ウィンドウのみカウント
visible_before = 0
FOR i = 0 TO win_count - 1
    id = ALL_WIN_ID[i]
    IF STATUS(id, ST_VISIBLE) THEN
        title = STATUS(id, ST_TITLE)
        class = STATUS(id, ST_CLASS)
        pid = STATUS(id, ST_PROCESS)
        
        visible_before = visible_before + 1
        FPUT(fid, "ID:" + id + " PID:" + pid + " Class:" + class + " Title:" + title)
    ENDIF
NEXT

FPUT(fid, "可視ウィンドウ数: " + visible_before)
FPUT(fid, "")

// cmd.exeを起動
FPUT(fid, "=== cmd.exe を起動 ===")
cmd_id = EXEC("cmd.exe")
FPUT(fid, "EXEC戻り値: " + cmd_id)
SLEEP(3)

// 起動後のウィンドウ一覧を取得
FPUT(fid, "")
FPUT(fid, "=== 起動後のウィンドウ一覧 ===")
win_count = GETALLWIN()
FPUT(fid, "総ウィンドウ数: " + win_count)

visible_after = 0
new_cmd_id = 0
new_cmd_pid = 0
FOR i = 0 TO win_count - 1
    id = ALL_WIN_ID[i]
    IF STATUS(id, ST_VISIBLE) THEN
        title = STATUS(id, ST_TITLE)
        class = STATUS(id, ST_CLASS)
        pid = STATUS(id, ST_PROCESS)
        
        visible_after = visible_after + 1
        FPUT(fid, "ID:" + id + " PID:" + pid + " Class:" + class + " Title:" + title)
        
        // 新しいcmdウィンドウを探す
        IF class = "ConsoleWindowClass" OR POS("cmd", title) > 0 THEN
            FPUT(fid, "  *** CMD ウィンドウ発見 ***")
            new_cmd_id = id
            new_cmd_pid = pid
        ENDIF
    ENDIF
NEXT

FPUT(fid, "可視ウィンドウ数: " + visible_after)
FPUT(fid, "増加数: " + (visible_after - visible_before))
FPUT(fid, "")
FPUT(fid, "=== 完了 ===")

// ファイルを閉じる
FCLOSE(fid)