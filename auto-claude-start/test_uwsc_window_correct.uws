// UWSCスクリプト - cmd起動前後のウィンドウ一覧を取得（正しい構文版）

// ログファイルパス
logfile = "C:\Users\user\claude-test-100-v0.2\auto-claude-start\uwsc_window_log.txt"

// ファイルを開く（読み書き両用モード）
fid = FOPEN(logfile, F_READ OR F_WRITE)

// 起動前のウィンドウ一覧を取得
FPUT(fid, "=== 起動前のウィンドウ一覧 ===")
GETTIME()
time_str = G_TIME_YY4 + "/" + G_TIME_MM2 + "/" + G_TIME_DD2 + " " + G_TIME_HH2 + ":" + G_TIME_NN2 + ":" + G_TIME_SS2
FPUT(fid, "時刻: " + time_str)

// ウィンドウを列挙
count_before = 0
FOR i = 0 TO 100
    hwnd = GETID("", "", i)
    IF hwnd = -1 THEN BREAK
    
    // 可視ウィンドウのみ記録
    IF STATUS(hwnd, ST_VISIBLE) THEN
        title = STATUS(hwnd, ST_TITLE)
        class = STATUS(hwnd, ST_CLASS)
        pid = STATUS(hwnd, ST_PROCESS)
        
        count_before = count_before + 1
        FPUT(fid, "HWND: " + hwnd + " | PID: " + pid + " | Class: " + class + " | Title: " + title)
    ENDIF
NEXT

FPUT(fid, "起動前のウィンドウ数: " + count_before)
FPUT(fid, "")

// cmd.exeを起動
FPUT(fid, "=== cmd.exe を起動 ===")
cmd_pid = EXEC("cmd.exe")
FPUT(fid, "起動したcmd.exe PID: " + cmd_pid)
SLEEP(2)

// 起動後のウィンドウ一覧を取得
FPUT(fid, "")
FPUT(fid, "=== 起動後のウィンドウ一覧 ===")
GETTIME()
time_str = G_TIME_YY4 + "/" + G_TIME_MM2 + "/" + G_TIME_DD2 + " " + G_TIME_HH2 + ":" + G_TIME_NN2 + ":" + G_TIME_SS2
FPUT(fid, "時刻: " + time_str)

count_after = 0
new_window_hwnd = 0
FOR i = 0 TO 100
    hwnd = GETID("", "", i)
    IF hwnd = -1 THEN BREAK
    
    IF STATUS(hwnd, ST_VISIBLE) THEN
        title = STATUS(hwnd, ST_TITLE)
        class = STATUS(hwnd, ST_CLASS)
        pid = STATUS(hwnd, ST_PROCESS)
        
        count_after = count_after + 1
        FPUT(fid, "HWND: " + hwnd + " | PID: " + pid + " | Class: " + class + " | Title: " + title)
        
        // 新しいcmdウィンドウを特定
        IF pid = cmd_pid THEN
            new_window_hwnd = hwnd
            FPUT(fid, "  *** これが新しく起動したcmdウィンドウです ***")
        ENDIF
    ENDIF
NEXT

FPUT(fid, "起動後のウィンドウ数: " + count_after)
FPUT(fid, "増加したウィンドウ数: " + (count_after - count_before))
FPUT(fid, "")
FPUT(fid, "=== 完了 ===")

// ファイルを閉じる（重要！）
FCLOSE(fid)

// コンソールに結果を表示
PRINT "起動前: " + count_before + " ウィンドウ"
PRINT "起動後: " + count_after + " ウィンドウ"
PRINT "新しいcmd HWND: " + new_window_hwnd
PRINT "ログファイル: " + logfile