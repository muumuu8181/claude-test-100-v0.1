// UWSCスクリプト - cmd起動前後のウィンドウ一覧を取得（修正版）

// ログファイル
logfile = "C:\Users\user\claude-test-100-v0.2\auto-claude-start\uwsc_window_log_fixed.txt"
fid = FOPEN(logfile, F_WRITE)

// 起動前のウィンドウ一覧を取得
FPUT(fid, "=== 起動前のウィンドウ一覧 ===")

// ウィンドウを列挙
count_before = 0
FOR i = 0 TO 100
    hwnd = GETID("", "", i)
    IF hwnd = -1 THEN BREAK
    
    // ウィンドウの情報を取得（classを使わない）
    title = STATUS(hwnd, ST_TITLE)
    clsname = STATUS(hwnd, ST_CLASS)
    pid = STATUS(hwnd, ST_PROCESS)
    
    // 可視ウィンドウのみ記録
    IF STATUS(hwnd, ST_VISIBLE) THEN
        count_before = count_before + 1
        FPUT(fid, "HWND: " + hwnd + " | PID: " + pid + " | Class: " + clsname + " | Title: " + title)
    ENDIF
NEXT

FPUT(fid, "起動前のウィンドウ数: " + count_before)
FPUT(fid, "")

// cmd.exeを起動
FPUT(fid, "=== cmd.exe を起動 ===")
cmd_pid = EXEC("cmd.exe")
FPUT(fid, "起動したcmd.exe PID: " + cmd_pid)
SLEEP(2)

// 起動後のウィンドウ一覧を取得
FPUT(fid, "")
FPUT(fid, "=== 起動後のウィンドウ一覧 ===")

count_after = 0
new_window_hwnd = 0
FOR i = 0 TO 100
    hwnd = GETID("", "", i)
    IF hwnd = -1 THEN BREAK
    
    IF STATUS(hwnd, ST_VISIBLE) THEN
        title = STATUS(hwnd, ST_TITLE)
        clsname = STATUS(hwnd, ST_CLASS)
        pid = STATUS(hwnd, ST_PROCESS)
        
        count_after = count_after + 1
        FPUT(fid, "HWND: " + hwnd + " | PID: " + pid + " | Class: " + clsname + " | Title: " + title)
        
        // 新しいcmdウィンドウを特定
        IF pid = cmd_pid THEN
            new_window_hwnd = hwnd
            FPUT(fid, "  *** これが新しく起動したcmdウィンドウです ***")
        ENDIF
    ENDIF
NEXT

FPUT(fid, "起動後のウィンドウ数: " + count_after)
FPUT(fid, "増加したウィンドウ数: " + (count_after - count_before))
FPUT(fid, "")
FPUT(fid, "=== 完了 ===")

// ファイルを閉じる
FCLOSE(fid)

// 完了のスクリーンショット
SAVEIMG("C:\Users\user\claude-test-100-v0.2\auto-claude-start\uwsc_window_list_complete.jpg", 0, , , , , , 70)